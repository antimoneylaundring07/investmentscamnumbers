<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Summary - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .activity-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .big-number {
            font-size: 32px;
            font-weight: bold;
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .activity-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .activity-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        .activity-table tbody tr:hover {
            background: #f8f9fa;
        }

        .username-badge {
            display: inline-block;
            background: #0066cc;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .admin-badge {
            background: #dc3545;
        }

        .column-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }

        .value-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
            max-width: 300px;
            word-break: break-word;
        }

        .timestamp {
            color: #666;
            font-size: 12px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-section label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .filter-section select,
        .filter-section input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h3>Investment Scam</h3>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="update_data.html">Update Data</a></li>
            <li><a href="tracker.html">Tracker</a></li>
            <li><a href="all_number.html">All Numbers</a></li>
            <li><a href="activity_summary.html" class="active">Activity Summary</a></li>
            <li>
                <a href="#" onclick="logout()" style="color: #dc3545; font-weight: 600;">
                    üö™ Logout
                </a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Activity Summary</h1>
            <span id="userEmail" style="color: #666; font-size: 14px;"></span>
        </div>

        <div id="loading" class="loading">Loading activity data...</div>

        <div id="summaryContainer" style="display: none;">
            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryCards"></div>

            <!-- Filters -->
            <div class="filter-section">
                <div>
                    <label>Filter by Username:</label>
                    <select id="userFilter" onchange="filterActivities()">
                        <option value="">All Users</option>
                    </select>
                </div>

                <div>
                    <label>Filter by Column:</label>
                    <select id="columnFilter" onchange="filterActivities()">
                        <option value="">All Columns</option>
                    </select>
                </div>

                <div>
                    <label>Filter by Date:</label>
                    <input type="date" id="dateFilter" onchange="filterActivities()">
                </div>
            </div>

            <!-- Activity Table -->
            <div class="activity-summary">
                <h2>üìä Recent Activity Updates</h2>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>üë§ Username</th>
                            <th>üìß Email</th>
                            <th>üîß Updated Column</th>
                            <th>‚úèÔ∏è New Value</th>
                            <th>‚è∞ Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="tracking_script.js"></script>
    <script>
        // Protect page
        protectPage();

        let allActivities = [];
        let filteredActivities = [];

        // Helper function to group activities by column
        function groupByColumn(activities) {
            const grouped = {};
            activities.forEach(activity => {
                const col = activity.column_name || 'Unknown';
                grouped[col] = (grouped[col] || 0) + 1;
            });
            return grouped;
        }

        // Helper function to group activities by user
        function groupByUser(activities) {
            const grouped = {};
            activities.forEach(activity => {
                const email = activity.user_email;
                if (!grouped[email]) {
                    grouped[email] = {
                        count: 0,
                        username: activity.username || email,
                        role: activity.user_role,
                        details: []
                    };
                }
                grouped[email].count += 1;
                grouped[email].details.push({
                    type: activity.activity_type,
                    column: activity.column_name,
                    value: activity.new_value,
                    timestamp: activity.timestamp
                });
            });
            return grouped;
        }

        async function loadActivityData() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    document.getElementById('loading').innerHTML = '<div class="no-data">‚ùå Please login first</div>';
                    return;
                }

                document.getElementById('userEmail').textContent = `üë§ ${user.email}`;

                let summary;

                // Check if user is admin
                if (user.role === 'admin') {
                    // Admin: fetch all activities
                    const { data: activities, error } = await supabaseClient
                        .from('activity_log')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) {
                        throw new Error(error.message);
                    }

                    summary = {
                        totalActivities: activities ? activities.length : 0,
                        uniqueUsers: activities ? new Set(activities.map(a => a.user_email)).size : 0,
                        activities: activities || [],
                        activitiesByUser: activities ? groupByUser(activities) : {},
                        activitiesByColumn: activities ? groupByColumn(activities) : {}
                    };
                } else {
                    // Regular user: fetch only their activities
                    const { data: activities, error } = await supabaseClient
                        .from('activity_log')
                        .select('*')
                        .eq('user_email', user.email)
                        .order('timestamp', { ascending: false });

                    if (error) {
                        throw new Error(error.message);
                    }

                    summary = {
                        totalEdits: activities ? activities.length : 0,
                        activities: activities || [],
                        editsByColumn: activities ? groupByColumn(activities) : {},
                        editsByDate: activities ? groupByDate(activities) : {},
                        username: activities && activities.length > 0 ? activities[0].username : user.username
                    };
                }

                if (!summary || !summary.activities || summary.activities.length === 0) {
                    document.getElementById('loading').innerHTML = '<div class="no-data">üì≠ No activity data found. Start making edits to see them here!</div>';
                    return;
                }

                allActivities = summary.activities || [];
                filteredActivities = [...allActivities];

                renderSummaryCards(summary);
                renderActivityTable(allActivities);
                populateFilters(allActivities);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('summaryContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading activity data:', error);
                document.getElementById('loading').innerHTML = `<div class="no-data">‚ùå Error loading data: ${error.message}</div>`;
            }
        }

        function groupByDate(activities) {
            const grouped = {};
            activities.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString();
                grouped[date] = (grouped[date] || 0) + 1;
            });
            return grouped;
        }

        function renderSummaryCards(summary) {
            const container = document.getElementById('summaryCards');
            const user = getCurrentUser();

            if (user.role === 'admin') {
                container.innerHTML = `
                    <div class="summary-card">
                        <h3>üìä Total Activities</h3>
                        <div class="big-number">${summary.totalActivities}</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>üë• Unique Users</h3>
                        <div class="big-number">${summary.uniqueUsers}</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>üîß Total Columns Edited</h3>
                        <div class="big-number">${Object.keys(summary.activitiesByColumn || {}).length}</div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="summary-card">
                        <h3>‚úèÔ∏è Your Total Edits</h3>
                        <div class="big-number">${summary.totalEdits}</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>üîß Columns Edited</h3>
                        <div class="big-number">${Object.keys(summary.editsByColumn || {}).length}</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>üìÖ Edit Days</h3>
                        <div class="big-number">${Object.keys(summary.editsByDate || {}).length}</div>
                    </div>
                `;
            }
        }

        function renderActivityTable(activities) {
            const tbody = document.getElementById('activityTableBody');

            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No activities found</td></tr>';
                return;
            }

            tbody.innerHTML = activities.map(activity => {
                const value = activity.new_value ? activity.new_value.substring(0, 50) : '-';
                const truncated = activity.new_value && activity.new_value.length > 50 ? '...' : '';

                return `
                    <tr>
                        <td>
                            <span class="username-badge ${activity.user_role === 'admin' ? 'admin-badge' : ''}">
                                ${activity.username || activity.user_email}
                            </span>
                        </td>
                        <td>
                            <small>${activity.user_email}</small>
                        </td>
                        <td>
                            <span class="column-badge">${activity.column_name || 'N/A'}</span>
                        </td>
                        <td>
                            <span class="value-badge">${value}${truncated}</span>
                        </td>
                        <td class="timestamp">${new Date(activity.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function populateFilters(activities) {
            // Get unique usernames
            const usernames = [...new Set(activities.map(a => a.username || a.user_email).filter(u => u))];
            const userFilter = document.getElementById('userFilter');

            usernames.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userFilter.appendChild(option);
            });

            // Get unique columns
            const columns = [...new Set(activities.map(a => a.column_name).filter(c => c))];
            const columnFilter = document.getElementById('columnFilter');

            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                columnFilter.appendChild(option);
            });
        }

        function filterActivities() {
            const userFilter = document.getElementById('userFilter').value;
            const columnFilter = document.getElementById('columnFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredActivities = allActivities.filter(activity => {
                let match = true;

                if (userFilter && (activity.username || activity.user_email) !== userFilter) {
                    match = false;
                }
                if (columnFilter && activity.column_name !== columnFilter) {
                    match = false;
                }

                if (dateFilter) {
                    const actDate = new Date(activity.timestamp).toLocaleDateString();
                    const filterDate = new Date(dateFilter).toLocaleDateString();
                    if (actDate !== filterDate) match = false;
                }

                return match;
            });

            renderActivityTable(filteredActivities);
        }

        // Load data on page load
        window.addEventListener('load', loadActivityData);
    </script>
</body>

</html>